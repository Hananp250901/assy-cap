<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil assy cap</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 15px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .form-input { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-grid div { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #555; }
        input, select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; font-size: 1em; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .header h1 { margin: 0; font-size: 1.8em; }
        .header-buttons { display: flex; gap: 10px; }
        .part-entry { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: grid; grid-template-columns: 2.5fr 1fr 1fr auto; gap: 15px; align-items: flex-end; }
        #add-part-btn { background-color: #28a745; }
        #add-part-btn:hover { background-color: #218838; }
        #save-all-btn { margin-top: 20px; padding: 12px; font-size: 1.1em; background-color: #dc3545; }
        #save-all-btn:hover { background-color: #c82333; }
        #parts-list-container { margin-top: 20px; }
        .part-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9f9f9; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; }
        .part-item span { flex-grow: 1; }
        .part-item button { width: auto; background-color: #6c757d; padding: 5px 10px; font-size: 0.8em; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 25px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .total-row td { font-weight: bold; background-color: #e9e9e9; }
        .edit-btn, .delete-btn { padding: 5px 10px; font-size: 0.8em; margin: 2px; width: auto; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .edit-btn { background-color: #ffc107; }
        .delete-btn { background-color: #dc3545; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        .edit-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin: 20px 0; }
        
        /* === CSS UNTUK PRINT === */
        @media print {
            body { margin: 0; padding: 0; font-size: 10pt; }
            .print-hide, .form-input, #parts-list-container, .header, .modal, .aksi-column {
                display: none !important;
            }
            .container { box-shadow: none; border: none; padding: 0; width: 100%; max-width: 100%; }
            #dashboard-area { margin: 0; }
            h3 { padding-top: 20px; font-size: 14pt; }
            table { display: table !important; }
            thead { display: table-header-group !important; }
            tbody { display: table-row-group !important; }
            tr { display: table-row !important; }
            td, th { display: table-cell !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Form input hasil assy cap</h1>
        <div class="header-buttons">
            <button onclick="exportToExcel()" class="print-hide">Download Excel</button>
            <button onclick="window.print()" class="print-hide">Print</button>
            <a href="dashboard-assy-cap.html" style="text-decoration: none;" class="print-hide"><button>Ke Dashboard Utama</button></a>
        </div>
    </div>
    
    <div class="form-input">
        <div class="form-grid">
            <div><label for="tanggal">Tanggal:</label><input type="date" id="tanggal" required></div>
            <div><label for="shift">Shift:</label><select id="shift" required><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
            <div><label for="nama">Nama:</label><select id="nama" required><option value="">Pilih Nama...</option></select></div>
        </div>
        
        <div class="part-entry">
            <div><label for="nama_part">Nama Part:</label><select id="nama_part"><option value="">Pilih Part...</option></select></div>
            <div><label for="jam_ke">Jam Ke-:</label><select id="jam_ke"><script>for(let i=1;i<=9;i++)document.write(`<option value="${i}">${i}</option>`)</script></select></div>
            <div><label for="quantity">Quantity:</label><input type="number" id="quantity" min="0"></div>
            <div><button type="button" id="add-part-btn">Tambah +</button></div>
        </div>
    </div>

    <div id="parts-list-container">
        <h3>Daftar Part untuk Disimpan</h3>
        <div id="parts-list"></div>
        <button type="button" id="save-all-btn">Simpan Semua Data</button>
    </div>

    <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
    <div id="dashboard-area"></div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeEditModal()">&times;</span>
        <h2>Edit Data Kuantitas</h2>
        <form id="edit-form">
            <input type="hidden" id="edit-record-id">
            <p><strong>Nama Part:</strong> <span id="edit-part-name"></span></p>
            <div class="edit-grid">
                <script>
                    for(let i = 1; i <= 9; i++) {
                        document.write(`<div><label for="edit_qty_jam_${i}">Jam ${i}:</label><input type="number" id="edit_qty_jam_${i}" min="0"></div>`);
                    }
                </script>
            </div>
            <button type="submit">Simpan Perubahan</button>
        </form>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://fbfvhcwisvlyodwvmpqg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiZnZoY3dpc3ZseW9kd3ZtcHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTQ2MzQsImV4cCI6MjA3MjM5MDYzNH0.mbn9B1xEr_8kmC2LOP5Jv5O7AEIK7Fa1gxrqJ91WNx4';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let masterPartsData = [];
    let stagedParts = [];
    const tanggalEl = document.getElementById('tanggal');
    const shiftEl = document.getElementById('shift');
    const namaEl = document.getElementById('nama');
    const namaPartEl = document.getElementById('nama_part');
    const jamKeEl = document.getElementById('jam_ke');
    const quantityEl = document.getElementById('quantity');
    const addPartBtn = document.getElementById('add-part-btn');
    const partsListDiv = document.getElementById('parts-list');
    const saveAllBtn = document.getElementById('save-all-btn');
    const dashboardArea = document.getElementById('dashboard-area');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editRecordId = document.getElementById('edit-record-id');
    const editPartName = document.getElementById('edit-part-name');

    async function loadMasterData() {
        const { data: people } = await db.from('master_people').select('id, nama').order('nama');
        if (people) {
            namaEl.innerHTML = '<option value="">Pilih Nama...</option>';
            people.forEach(person => namaEl.add(new Option(person.nama, person.id)));
        }
        
        const { data: parts, error } = await db.from('master_assy_cap').select('id, nama_part, part_number').order('nama_part');
        if (parts) {
            masterPartsData = parts;
            namaPartEl.innerHTML = '<option value="">Pilih Part...</option>';
            parts.forEach(part => {
                const option = new Option(part.nama_part, part.id);
                option.dataset.partNumber = part.part_number;
                option.dataset.partName = part.nama_part;
                namaPartEl.add(option);
            });
        } else {
            console.error("Gagal memuat data master part:", error);
        }
    }
    
    async function displayDashboard(tanggal) {
        dashboardArea.innerHTML = '<h3>Memuat data...</h3>';
        const { data, error } = await db.from('production_log').select(`*, master_people(nama)`).eq('tanggal', tanggal).order('created_at');
        if (error) { dashboardArea.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`; return; }
        if (!data || data.length === 0) { dashboardArea.innerHTML = '<h3>Tidak ada data untuk tanggal ini.</h3>'; return; }

        const groupedData = data.reduce((acc, curr) => {
            const key = curr.master_people ? curr.master_people.nama : 'Tanpa Nama';
            if (!acc[key]) acc[key] = [];
            acc[key].push(curr);
            return acc;
        }, {});

        let html = '';
        const formattedDate = new Date(tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

        for (const personName in groupedData) {
            const records = groupedData[personName];
            const shift = records[0].shift;
            const totals = Array(9).fill(0);
            let grandTotal = 0;

            html += `<h3>NAMA: ${personName} &nbsp;&nbsp;|&nbsp;&nbsp; SHIFT: ${shift} &nbsp;&nbsp;|&nbsp;&nbsp; TANGGAL: ${formattedDate}</h3>`;
            html += `<table><thead><tr><th>NO</th><th>NAMA PART</th>${Array.from({length: 9}, (_, i) => `<th>${i+1}</th>`).join('')}<th>TOTAL</th><th class="aksi-column">AKSI</th></tr></thead><tbody>`;
            
            records.forEach((rec, index) => {
                let rowTotal = 0;
                const partInfo = masterPartsData.find(p => p.id === rec.part_id);
                const partName = partInfo ? partInfo.nama_part : `Part ID: ${rec.part_id}`;
                html += `<tr><td>${index + 1}</td><td>${partName}</td>`;
                for (let i = 1; i <= 9; i++) {
                    const qty = rec[`qty_jam_${i}`] || 0;
                    html += `<td>${qty > 0 ? qty : ''}</td>`;
                    totals[i - 1] += qty;
                    rowTotal += qty;
                }
                grandTotal += rowTotal;
                html += `<td class="aksi-column">${rowTotal}</td><td class="aksi-column"><button class="edit-btn" onclick="openEditModal(${rec.id})">Edit</button><button class="delete-btn" onclick="deleteRecord(${rec.id})">Hapus</button></td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="2">TOTAL</td>${totals.map(t => `<td>${t > 0 ? t : ''}</td>`).join('')}<td>${grandTotal}</td><td class="aksi-column"></td></tr></tbody></table>`;
        }
        dashboardArea.innerHTML = html;
    }

    function renderStagedParts() {
        partsListDiv.innerHTML = !stagedParts.length ? '<p style="color:#777; font-style:italic;">Belum ada part yang ditambahkan.</p>' : '';
        stagedParts.forEach((part, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'part-item';
            itemDiv.innerHTML = `<span><strong>${part.partName}</strong> (Jam: ${part.jamKe}, Qty: ${part.quantity})</span><button onclick="removeStagedPart(${index})">Hapus</button>`;
            partsListDiv.appendChild(itemDiv);
        });
    }

    function removeStagedPart(index) {
        stagedParts.splice(index, 1);
        renderStagedParts();
    }
    
    async function saveAllParts() {
        if (stagedParts.length === 0 || !tanggalEl.value || !shiftEl.value || !namaEl.value) {
            alert('Harap lengkapi semua data dan tambahkan minimal satu part.'); return;
        }
        
        const summary = new Map();
        stagedParts.forEach(part => {
            if (!summary.has(part.partId)) summary.set(part.partId, { ...part, quantity: 0 });
            summary.get(part.partId).quantity += part.quantity;
        });

        const recordsForDashboard = Array.from(summary.values()).map(part => ({
            tanggal: tanggalEl.value, shift: parseInt(shiftEl.value), people: namaEl.options[namaEl.selectedIndex].text,
            part_name: part.partName, part_number: part.partNumber, qty: part.quantity
        }));

        const logUpsertMap = new Map();
        stagedParts.forEach(log => {
            if (!logUpsertMap.has(log.partId)) {
                logUpsertMap.set(log.partId, {
                    tanggal: tanggalEl.value, shift: parseInt(shiftEl.value), person_id: parseInt(namaEl.value), part_id: log.partId
                });
            }
            const existing = logUpsertMap.get(log.partId);
            existing[`qty_jam_${log.jamKe}`] = (existing[`qty_jam_${log.jamKe}`] || 0) + log.quantity;
        });
        const finalRecordsForLog = Array.from(logUpsertMap.values());

        try {
            const { error: dashboardError } = await db.from('hasil_assy_cap').insert(recordsForDashboard);
            if (dashboardError) throw dashboardError;
            
            const { error: logError } = await db.from('production_log').upsert(finalRecordsForLog, { onConflict: 'tanggal, shift, person_id, part_id' });
            if (logError) throw logError;
            
            alert('Semua data berhasil disimpan!');
            stagedParts = [];
            renderStagedParts();
            jamKeEl.value = '1';
            displayDashboard(tanggalEl.value);
        } catch (error) {
            alert('Gagal menyimpan data: ' + error.message);
        }
    }
    
    async function openEditModal(recordId) {
        const { data, error } = await db.from('production_log').select(`*`).eq('id', recordId).single();
        if (error || !data) { alert('Gagal mengambil data untuk diedit!'); return; }
        editRecordId.value = data.id;
        const partInfo = masterPartsData.find(p => p.id === data.part_id);
        editPartName.textContent = partInfo ? partInfo.nama_part : 'Part tidak ditemukan';
        for (let i = 1; i <= 9; i++) document.getElementById(`edit_qty_jam_${i}`).value = data[`qty_jam_${i}`] || '';
        editModal.style.display = 'block';
    }

    function closeEditModal() { editModal.style.display = 'none'; }

    async function deleteRecord(recordId) {
        if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
        const { error } = await db.from('production_log').delete().eq('id', recordId);
        if (error) alert('Gagal menghapus data: ' + error.message);
        else {
            alert('Data berhasil dihapus.');
            displayDashboard(tanggalEl.value);
        }
    }

    function exportToExcel() {
        const tables = document.querySelectorAll('#dashboard-area table');
        if (tables.length === 0) return alert('Tidak ada data untuk di-export!');
        const wb = XLSX.utils.book_new();
        tables.forEach(table => {
            const personName = table.previousElementSibling.innerText.split('|')[0].replace('NAMA: ', '').trim();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, personName.slice(0, 30));
        });
        XLSX.writeFile(wb, `Laporan Produksi ${tanggalEl.value}.xlsx`);
    }

    document.addEventListener('DOMContentLoaded', () => {
        tanggalEl.value = new Date().toISOString().split('T')[0];
        loadMasterData().then(() => {
            displayDashboard(tanggalEl.value);
        });
        renderStagedParts();
    });
    
    tanggalEl.addEventListener('change', () => displayDashboard(tanggalEl.value));

    addPartBtn.addEventListener('click', () => {
        const selectedOption = namaPartEl.options[namaPartEl.selectedIndex];
        if (!selectedOption.value) { alert('Pilih Nama Part terlebih dahulu!'); return; }
        const partId = parseInt(selectedOption.value), partName = selectedOption.dataset.partName;
        const partNumber = selectedOption.dataset.partNumber, jamKe = parseInt(jamKeEl.value);
        const quantity = parseInt(quantityEl.value);
        if (!quantity || quantity <= 0) { alert('Isi Quantity dengan benar!'); return; }
        stagedParts.push({ partId, partName, partNumber, jamKe, quantity });
        renderStagedParts();
        namaPartEl.value = ''; quantityEl.value = ''; namaPartEl.focus();
        jamKeEl.value = (jamKe % 9) + 1;
    });

    saveAllBtn.addEventListener('click', saveAllParts);

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const recordId = editRecordId.value;
        const updates = {};
        for (let i = 1; i <= 9; i++) updates[`qty_jam_${i}`] = parseInt(document.getElementById(`edit_qty_jam_${i}`).value) || null;
        const { error } = await db.from('production_log').update(updates).eq('id', recordId);
        if (error) alert('Gagal menyimpan perubahan: ' + error.message);
        else {
            alert('Data berhasil diperbarui!');
            closeEditModal();
            displayDashboard(tanggalEl.value);
        }
    });

    window.removeStagedPart = removeStagedPart;
    window.openEditModal = openEditModal;
    window.closeEditModal = closeEditModal;
    window.deleteRecord = deleteRecord;
    window.exportToExcel = exportToExcel;
</script>
</body>
</html>